<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflow trong Browser Rendering Demo</title>
    <link rel="stylesheet" href="reflow-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîÑ Reflow trong Browser Rendering</h1>
            <p class="subtitle">Hi·ªÉu v·ªÅ quy tr√¨nh render v√† t·ªëi ∆∞u hi·ªáu nƒÉng</p>
        </header>

        <!-- Render Pipeline Section -->
        <section class="demo-section">
            <h2>1. Quy tr√¨nh x√¢y d·ª±ng Render Tree</h2>
            <div class="explanation">
                <p><strong>Browser ƒë·ªçc HTML ‚Üí DOM Tree</strong></p>
                <p><strong>ƒê·ªçc CSS ‚Üí CSSOM Tree</strong></p>
                <p><strong>K·∫øt h·ª£p DOM + CSSOM ‚Üí Render Tree</strong></p>
            </div>
            
            <div class="pipeline-demo">
                <div class="pipeline-step">
                    <div class="step-box html-step">
                        <h3>HTML</h3>
                        <div class="code-snippet">
                            <code>&lt;div class="box"&gt;Content&lt;/div&gt;</code>
                        </div>
                    </div>
                    <div class="arrow">‚Üí</div>
                    <div class="step-box dom-step">
                        <h3>DOM Tree</h3>
                        <div class="tree-structure">
                            <div class="node">div.box</div>
                            <div class="node child">"Content"</div>
                        </div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-box css-step">
                        <h3>CSS</h3>
                        <div class="code-snippet">
                            <code>.box { width: 100px; height: 50px; }</code>
                        </div>
                    </div>
                    <div class="arrow">‚Üí</div>
                    <div class="step-box cssom-step">
                        <h3>CSSOM Tree</h3>
                        <div class="tree-structure">
                            <div class="node">.box</div>
                            <div class="node child">width: 100px</div>
                            <div class="node child">height: 50px</div>
                        </div>
                    </div>
                </div>
                
                <div class="pipeline-step">
                    <div class="step-box render-step">
                        <h3>Render Tree</h3>
                        <div class="tree-structure">
                            <div class="node">div.box</div>
                            <div class="node child">width: 100px</div>
                            <div class="node child">height: 50px</div>
                            <div class="node child">"Content"</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reflow Definition Section -->
        <section class="demo-section">
            <h2>2. Reflow l√† g√¨?</h2>
            <div class="explanation">
                <p>X·∫£y ra khi DOM ho·∫∑c CSSOM b·ªã thay ƒë·ªïi (JS, React, th√™m node, ƒë·ªïi style)</p>
                <p>Browser ph·∫£i th·ª±c hi·ªán 4 b∆∞·ªõc:</p>
            </div>
            
            <div class="reflow-steps">
                <div class="reflow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Recalculate Style</h3>
                        <p>CSS selectors, style tree</p>
                    </div>
                </div>
                <div class="reflow-step cpu-heavy">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>Layout Phase</h3>
                        <p>T√≠nh to√°n l·∫°i v·ªã tr√≠, k√≠ch th∆∞·ªõc (CPU bound, n·∫∑ng)</p>
                    </div>
                </div>
                <div class="reflow-step gpu-fast">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>Paint Phase</h3>
                        <p>V·∫Ω pixel l√™n m√†n h√¨nh (GPU, nhanh)</p>
                    </div>
                </div>
                <div class="reflow-step gpu-fast">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h3>Composite Phase</h3>
                        <p>S·∫Øp x·∫øp c√°c layer ƒë√∫ng th·ª© t·ª± hi·ªÉn th·ªã</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CPU vs GPU Section -->
        <section class="demo-section">
            <h2>3. CPU vs GPU</h2>
            <div class="explanation">
                <p><strong>Reflow + Layout = CPU n·∫∑ng</strong> ‚Üí d·ªÖ block render thread n·∫øu x·∫£y ra nhi·ªÅu</p>
                <p><strong>Paint + Composite = GPU x·ª≠ l√Ω</strong> ‚Üí nhanh, kh√¥ng block CPU</p>
            </div>
            
            <div class="cpu-gpu-demo">
                <div class="processor-box cpu-box">
                    <h3>ÔøΩÔøΩÔ∏è CPU (Main Thread)</h3>
                    <div class="cpu-tasks">
                        <div class="task cpu-task">JavaScript Execution</div>
                        <div class="task cpu-task">DOM Manipulation</div>
                        <div class="task cpu-task heavy">Layout Calculation</div>
                        <div class="task cpu-task heavy">Style Recalculation</div>
                    </div>
                    <div class="performance-indicator">
                        <span class="label">Performance:</span>
                        <span class="value slow">Ch·∫≠m, Blocking</span>
                    </div>
                </div>
                
                <div class="processor-box gpu-box">
                    <h3>üéÆ GPU (Compositor Thread)</h3>
                    <div class="gpu-tasks">
                        <div class="task gpu-task">Pixel Painting</div>
                        <div class="task gpu-task">Layer Compositing</div>
                        <div class="task gpu-task">Transform Operations</div>
                        <div class="task gpu-task">Opacity Changes</div>
                    </div>
                    <div class="performance-indicator">
                        <span class="label">Performance:</span>
                        <span class="value fast">Nhanh, Non-blocking</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Performance Demo Section -->
        <section class="demo-section">
            <h2>4. V√≠ d·ª• hi·ªáu nƒÉng - 2000 Rectangles</h2>
            <div class="explanation">
                <p><strong>Render 2000 rectangles:</strong></p>
                <p>‚Ä¢ Pipeline t·ªëi ∆∞u (CSS transform: translateY) ‚Üí GPU v·∫Ω pixel ‚Üí 60fps, CPU g·∫ßn nh∆∞ 0%</p>
                <p>‚Ä¢ Pipeline kh√¥ng t·ªëi ∆∞u (CSS margin-top) ‚Üí CPU ph·∫£i t√≠nh l·∫°i layout cho t·∫•t c·∫£ 2000 elements ‚Üí n·∫∑ng, lag</p>
            </div>
            
            <div class="performance-demo">
                <div class="demo-controls">
                    <button id="startReflowDemo" class="demo-btn reflow-btn">üö´ Demo Reflow (Ch·∫≠m)</button>
                    <button id="startTransformDemo" class="demo-btn transform-btn">‚úÖ Demo Transform (Nhanh)</button>
                    <button id="stopDemo" class="demo-btn stop-btn">‚èπÔ∏è D·ª´ng</button>
                </div>
                
                <div class="performance-metrics">
                    <div class="metric">
                        <span class="metric-label">FPS:</span>
                        <span class="metric-value" id="fpsCounter">60</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">CPU Usage:</span>
                        <span class="metric-value" id="cpuUsage">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Elements:</span>
                        <span class="metric-value">2000</span>
                    </div>
                </div>
                
                <div class="animation-container" id="animationContainer">
                    <!-- 2000 rectangles will be generated here -->
                </div>
            </div>
        </section>

        <!-- Optimization Examples Section -->
        <section class="demo-section">
            <h2>5. T·ªëi ∆∞u h√≥a - Tr√°nh Reflow</h2>
            <div class="explanation">
                <p><strong>Reflow = t·ªën k√©m nh·∫•t v√¨ t√≠nh to√°n l·∫°i layout</strong></p>
                <p>T·ªëi ∆∞u b·∫±ng c√°ch h·∫°n ch·∫ø thay ƒë·ªïi layout v√† ∆∞u ti√™n d√πng transform, opacity</p>
            </div>
            
            <div class="optimization-demo">
                <div class="comparison">
                    <div class="comparison-side bad-side">
                        <h3>‚ùå Kh√¥ng t·ªëi ∆∞u (G√¢y Reflow)</h3>
                        <div class="code-example">
                            <pre><code>// Thay ƒë·ªïi layout properties
element.style.width = '200px';
element.style.height = '100px';
element.style.marginTop = '50px';
element.style.padding = '20px';</code></pre>
                        </div>
                        <div class="impact">
                            <span class="impact-label">T√°c ƒë·ªông:</span>
                            <span class="impact-value bad">CPU n·∫∑ng, Layout recalculation</span>
                        </div>
                    </div>
                    
                    <div class="comparison-side good-side">
                        <h3>‚úÖ T·ªëi ∆∞u (GPU Layer)</h3>
                        <div class="code-example">
                            <pre><code>// S·ª≠ d·ª•ng transform v√† opacity
element.style.transform = 'translateY(50px)';
element.style.opacity = '0.8';
element.style.scale = '1.2';</code></pre>
                        </div>
                        <div class="impact">
                            <span class="impact-label">T√°c ƒë·ªông:</span>
                            <span class="impact-value good">GPU x·ª≠ l√Ω, 60fps</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Animation Demo -->
        <section class="demo-section">
            <h2>6. Demo t∆∞∆°ng t√°c - So s√°nh hi·ªáu nƒÉng</h2>
            <div class="interactive-demo">
                <div class="demo-controls">
                    <button id="animateReflow" class="demo-btn reflow-btn">Animate v·ªõi Margin (Reflow)</button>
                    <button id="animateTransform" class="demo-btn transform-btn">Animate v·ªõi Transform</button>
                    <button id="resetAnimation" class="demo-btn reset-btn">Reset</button>
                </div>
                
                <div class="animation-comparison">
                    <div class="animation-box">
                        <h4>Reflow Animation</h4>
                        <div class="demo-element reflow-element" id="reflowElement">Box 1</div>
                        <div class="demo-element reflow-element" id="reflowElement2">Box 2</div>
                        <div class="demo-element reflow-element" id="reflowElement3">Box 3</div>
                    </div>
                    
                    <div class="animation-box">
                        <h4>Transform Animation</h4>
                        <div class="demo-element transform-element" id="transformElement">Box 1</div>
                        <div class="demo-element transform-element" id="transformElement2">Box 2</div>
                        <div class="demo-element transform-element" id="transformElement3">Box 3</div>
                    </div>
                </div>
                
                <div class="performance-comparison">
                    <div class="perf-metric">
                        <h4>Reflow Performance</h4>
                        <div class="perf-bar">
                            <div class="perf-fill reflow-perf" id="reflowPerf"></div>
                        </div>
                        <span class="perf-text" id="reflowText">Ch·∫≠m</span>
                    </div>
                    
                    <div class="perf-metric">
                        <h4>Transform Performance</h4>
                        <div class="perf-bar">
                            <div class="perf-fill transform-perf" id="transformPerf"></div>
                        </div>
                        <span class="perf-text" id="transformText">Nhanh</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Summary Section -->
        <section class="demo-section summary">
            <h2>üìù T√≥m t·∫Øt</h2>
            <div class="summary-content">
                <div class="summary-point">
                    <h3>Reflow = T·ªën k√©m nh·∫•t</h3>
                    <p>Khi DOM/CSS thay ƒë·ªïi, browser ph·∫£i t√≠nh to√°n l·∫°i layout (n·∫∑ng CPU)</p>
                </div>
                <div class="summary-point">
                    <h3>Paint + Composite = Nhanh h∆°n</h3>
                    <p>Ch·ªß y·∫øu GPU x·ª≠ l√Ω, kh√¥ng block CPU</p>
                </div>
                <div class="summary-point">
                    <h3>T·ªëi ∆∞u Animation/Layout</h3>
                    <p>S·ª≠ d·ª•ng transform/opacity ƒë·ªÉ tr√°nh reflow</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Performance monitoring
        let animationId;
        let startTime;
        let frameCount = 0;
        let isAnimating = false;

        // Generate 2000 rectangles for performance demo
        function generateRectangles() {
            const container = document.getElementById('animationContainer');
            container.innerHTML = '';
            
            for (let i = 0; i < 2000; i++) {
                const rect = document.createElement('div');
                rect.className = 'performance-rect';
                rect.style.left = Math.random() * 800 + 'px';
                rect.style.top = Math.random() * 400 + 'px';
                container.appendChild(rect);
            }
        }

        // Reflow animation (using margin)
        function animateReflow() {
            const rects = document.querySelectorAll('.performance-rect');
            let direction = 1;
            
            function animate() {
                if (!isAnimating) return;
                
                rects.forEach(rect => {
                    const currentMargin = parseInt(rect.style.marginTop) || 0;
                    rect.style.marginTop = (currentMargin + direction * 2) + 'px';
                });
                
                if (Math.abs(parseInt(rects[0].style.marginTop) || 0) > 100) {
                    direction *= -1;
                }
                
                updatePerformanceMetrics();
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Transform animation (GPU optimized)
        function animateTransform() {
            const rects = document.querySelectorAll('.performance-rect');
            let direction = 1;
            
            function animate() {
                if (!isAnimating) return;
                
                rects.forEach(rect => {
                    const currentTransform = rect.style.transform || 'translateY(0px)';
                    const currentY = parseInt(currentTransform.match(/-?\d+/) || [0])[0];
                    rect.style.transform = `translateY(${currentY + direction * 2}px)`;
                });
                
                if (Math.abs(parseInt(rects[0].style.transform.match(/-?\d+/) || [0])[0]) > 100) {
                    direction *= -1;
                }
                
                updatePerformanceMetrics();
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Update performance metrics
        function updatePerformanceMetrics() {
            frameCount++;
            const currentTime = performance.now();
            const elapsed = currentTime - startTime;
            
            if (elapsed >= 1000) {
                const fps = Math.round((frameCount * 1000) / elapsed);
                document.getElementById('fpsCounter').textContent = fps;
                
                // Simulate CPU usage based on animation type
                const cpuUsage = isAnimating ? (document.querySelector('.reflow-btn').classList.contains('active') ? 85 : 15) : 0;
                document.getElementById('cpuUsage').textContent = cpuUsage + '%';
                
                frameCount = 0;
                startTime = currentTime;
            }
        }

        // Interactive demo elements
        function animateInteractiveReflow() {
            const elements = ['reflowElement', 'reflowElement2', 'reflowElement3'];
            elements.forEach((id, index) => {
                const element = document.getElementById(id);
                element.style.animation = 'none';
                setTimeout(() => {
                    element.style.animation = `reflowAnimation 2s ease-in-out infinite`;
                }, index * 200);
            });
            
            // Update performance indicator
            document.getElementById('reflowPerf').style.width = '20%';
            document.getElementById('reflowText').textContent = 'Ch·∫≠m (CPU)';
        }

        function animateInteractiveTransform() {
            const elements = ['transformElement', 'transformElement2', 'transformElement3'];
            elements.forEach((id, index) => {
                const element = document.getElementById(id);
                element.style.animation = 'none';
                setTimeout(() => {
                    element.style.animation = `transformAnimation 2s ease-in-out infinite`;
                }, index * 200);
            });
            
            // Update performance indicator
            document.getElementById('transformPerf').style.width = '90%';
            document.getElementById('transformText').textContent = 'Nhanh (GPU)';
        }

        function resetAnimation() {
            const allElements = document.querySelectorAll('.demo-element');
            allElements.forEach(el => {
                el.style.animation = 'none';
            });
            
            // Reset performance indicators
            document.getElementById('reflowPerf').style.width = '0%';
            document.getElementById('transformPerf').style.width = '0%';
            document.getElementById('reflowText').textContent = 'Tƒ©nh';
            document.getElementById('transformText').textContent = 'Tƒ©nh';
        }

        // Event listeners
        document.getElementById('startReflowDemo').addEventListener('click', function() {
            if (isAnimating) return;
            isAnimating = true;
            startTime = performance.now();
            frameCount = 0;
            this.classList.add('active');
            document.getElementById('startTransformDemo').classList.remove('active');
            animateReflow();
        });

        document.getElementById('startTransformDemo').addEventListener('click', function() {
            if (isAnimating) return;
            isAnimating = true;
            startTime = performance.now();
            frameCount = 0;
            this.classList.add('active');
            document.getElementById('startReflowDemo').classList.remove('active');
            animateTransform();
        });

        document.getElementById('stopDemo').addEventListener('click', function() {
            isAnimating = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            document.querySelectorAll('.demo-btn').forEach(btn => btn.classList.remove('active'));
        });

        document.getElementById('animateReflow').addEventListener('click', animateInteractiveReflow);
        document.getElementById('animateTransform').addEventListener('click', animateInteractiveTransform);
        document.getElementById('resetAnimation').addEventListener('click', resetAnimation);

        // Initialize
        generateRectangles();
        startTime = performance.now();
    </script>
</body>
</html>
